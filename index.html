<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Futbol Turnuvası</title>
<style>
    html, body { height:100%; margin:0; padding:0; background-color:black; }
    body {
        font-family: Arial, sans-serif;
        background: url('photo_001.png') no-repeat center bottom;
        background-size: cover; color:#fff;
    }
    h1 { text-align:center; margin-top:20px; text-shadow:2px 2px #000; }
    input, button { padding:8px; margin:5px; font-size:20px; border-radius:5px; border:none; }
    button { background-color:#1a73e8; color:#fff; cursor:pointer; }
    button:hover { background-color:#155ab6; }
    .team-entry, .team-list, .match-section, .standings, .champion-box, .saved-section {
        background-color: rgba(0,0,50,0.8);
        margin: 15px auto; padding:20px; border-radius:10px; max-width:750px;
    }
    .team-list ul { list-style:none; padding-left:0; }
    .team-list li { padding:5px; border-bottom:1px solid #ccc; display:flex; align-items:center; }
    .team-list img { width:40px; height:40px; border-radius:50%; margin-right:10px; border:2px solid #fff; }

    .match-card { background-color: rgba(255,255,255,0.1); padding:10px; margin-bottom:10px; border-radius:8px;
        display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .match-card input { width:50px; text-align:center; }

    table { width:100%; border-collapse:collapse; margin-top:10px; background-color: rgba(0,0,80,0.7); border-radius:10px; overflow:hidden; }
    th, td { border:1px solid #fff; padding:5px; text-align:center; font-size:14px; }
    th { background-color: rgba(0,0,100,0.8); }

    .tournament { text-align:center; }

    .champion-box h3 { text-align:center; margin:0; }
    .champion-box p { display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:bold; }
    .champion-photo { width:80px; height:80px; border-radius:50%; margin-right:20px; border:4px solid gold; }

    .saved-list { list-style:none; padding-left:0; }
    .saved-list li { padding:8px; border-bottom:1px solid #666; display:flex; justify-content:space-between; align-items:center; }
    .saved-list .meta { display:flex; align-items:center; gap:10px; }

    .confetti-container { position: fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; overflow:visible; z-index:9999; }
    .confetti { position:absolute; width:10px; height:14px; opacity:0.9; transform-origin:center; will-change:transform, top; animation: fall linear forwards; }
    @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity:1; } 100% { transform: translateY(110vh) rotate(720deg); opacity:0.9; } }

    @media (max-width:600px) { th, td { font-size:12px; padding:4px; } input, button { font-size:14px; padding:4px; } .match-card { flex-direction:column; } }
</style>
</head>
<body>
<h1>Futbol Turnuvası</h1>

<div class="team-entry">
    <input type="text" id="playerName" placeholder="Oyuncu Adı" />
    <input type="text" id="teamName" placeholder="Takım Adı" />
    <button id="addTeamBtn">Takımı Ekle</button>
    <button id="clearTeamsBtn">Takımları Temizle</button>
</div>

<div class="team-list">
    <h3>Takımlar:</h3>
    <ul id="teamList"></ul>
</div>

<div class="tournament">
    <button id="startTournamentBtn">Turnuvayı Başlat</button>
    <button id="showSavedBtn">Eski Turnuvaları Göster</button>

    <div class="match-section" id="matchSection" style="display:none;">
        <h3 id="weekTitle"></h3>
        <div id="matchList"></div>
    </div>

    <div class="standings" id="standings">
        <h3>Puan Tablosu:</h3>
        <table id="pointsTable">
            <thead>
                <tr>
                    <th>Sıra</th><th>Takım</th><th>Puan</th><th>O</th><th>G</th><th>B</th><th>M</th><th>AG</th><th>YG</th><th>AV</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="champion-box" id="championBox" style="display:none;">
        <h3>Şampiyon:</h3>
        <p id="championInfo"></p>
        <div style="text-align:center; margin-top:10px;"><button id="archiveClearBtn">Arşive Aktarıldıysa Bu Turnuvayı Temizle</button></div>
    </div>

    <div class="saved-section" id="savedSection" style="display:none;">
        <h3>Eski Turnuvalar</h3>
        <ul id="savedList" class="saved-list"></ul>
        <div id="savedDetails" style="margin-top:10px;"></div>
    </div>
</div>

<div class="confetti-container" id="confettiContainer" aria-hidden="true"></div>

<script>
/* --------- Ayarlar / Anahtarlar ---------- */
const STORAGE_KEY = 'savedTournaments_v1';   // tamamlanmışlar
const AUTOSAVE_KEY = 'ongoingTournament_v1'; // devam eden turnuva
const playerPhotos = {"Faruk":"Faruk.png","Rıza":"Rıza.png","Hakan":"Hakan.png","Salih":"Salih.png","Hidayet":"Hidayet.png","Ergün":"Ergün.png","İsmail":"İsmail.png","Uğur":"default.png"};

/* --------- Veri yapıları ---------- */
const teams = []; // aktif Team nesneleri
let weeksMatches = []; // [ [ [homeObj, awayObj], ... ], ... ]
let currentWeek = 0;
const matchResults = {}; // `${week}-${matchIndex}` => { homeGoals, awayGoals, ... }

/* --------- Sınıf ---------- */
class Team {
    constructor(playerName, teamName) {
        this.playerName = playerName;
        this.teamName = teamName;
        this.played = 0;
        this.won = 0;
        this.draw = 0;
        this.lost = 0;
        this.goalsFor = 0;
        this.goalsAgainst = 0;
    }
    get points(){ return this.won*3 + this.draw; }
    get goalDifference(){ return this.goalsFor - this.goalsAgainst; }
}

/* --------- Butonlar / Eventler ---------- */
document.getElementById("addTeamBtn").onclick = () => {
    const player = document.getElementById("playerName").value.trim();
    const team = document.getElementById("teamName").value.trim();
    if(player && team){
        teams.push(new Team(player, team));
        updateTeamList();
        document.getElementById("playerName").value = '';
        document.getElementById("teamName").value = '';
    } else alert("Tüm alanları doldurun!");
};

document.getElementById("clearTeamsBtn").onclick = () => {
    if(confirm("Tüm takımları temizlemek istiyor musun?")) {
        teams.length = 0;
        updateTeamList();
        clearAutoState();
    }
};

document.getElementById("startTournamentBtn").onclick = () => {
    if(teams.length < 2){ alert("Turnuva başlatmak için en az 2 takım ekleyin!"); return; }
    resetStats();
    prepareWeeklyMatches();
    saveAutoState(); // başlatıldığında ilk kayıt
    document.getElementById("startTournamentBtn").style.display = "none";
    document.getElementById("showSavedBtn").style.display = "none";
    showWeek(currentWeek);
};

document.getElementById("showSavedBtn").onclick = toggleSavedSection;
document.getElementById("archiveClearBtn").onclick = () => {
    // Bu buton, gösterilen şampiyon turnuva bittikten sonra kullanıcı isterse ara kaydı ve takımları temizleyebilir.
    if(confirm("Bu tamamlanmış turnuvayı temizlemek ve yeni bir turnuva başlatmak istiyor musun?")){
        clearAutoState();
        teams.length = 0;
        updateTeamList();
        document.getElementById("championBox").style.display = "none";
        document.getElementById("startTournamentBtn").style.display = "inline-block";
        document.getElementById("showSavedBtn").style.display = "inline-block";
        document.getElementById("savedDetails").innerHTML = '';
    }
};

/* --------- Görüntüleme güncellemeleri ---------- */
function updateTeamList(){
    const ul = document.getElementById("teamList");
    ul.innerHTML = '';
    teams.forEach(t => {
        const li = document.createElement("li");
        const photoUrl = playerPhotos[t.playerName] || 'default.png';
        li.innerHTML = `<img src="${photoUrl}" alt="${t.playerName}"><span>${t.playerName} - ${t.teamName}</span>`;
        ul.appendChild(li);
    });
}

function showWeek(week){
    document.getElementById("matchSection").style.display = "block";
    document.getElementById("weekTitle").textContent = `Hafta ${week+1} / Toplam ${weeksMatches.length} Hafta`;
    const matchList = document.getElementById("matchList");
    matchList.innerHTML = '';
    weeksMatches[week].forEach((m, i) => {
        const div = document.createElement("div");
        div.className = "match-card";
        const key = `${week}-${i}`;
        const existing = matchResults[key];
        const valA = existing ? existing.homeGoals : '';
        const valB = existing ? existing.awayGoals : '';
        div.innerHTML = `
            <span>${m[0].playerName} (${m[0].teamName}) vs ${m[1].playerName} (${m[1].teamName})</span>
            <input type="number" placeholder="Gol" class="scoreA" value="${valA}">
            <input type="number" placeholder="Gol" class="scoreB" value="${valB}">
            <button onclick="submitMatch(${week},${i})">Kaydet</button>
        `;
        matchList.appendChild(div);
    });
}

/* --------- Lig & Fikstür ---------- */
function resetStats(){
    teams.forEach(t => {
        t.played = t.won = t.draw = t.lost = t.goalsFor = t.goalsAgainst = 0;
    });
    weeksMatches = [];
    currentWeek = 0;
    for(const k in matchResults) delete matchResults[k];
    document.getElementById("championBox").style.display = "none";
    document.getElementById("matchSection").style.display = "none";
    updateStandings();
}

function prepareWeeklyMatches(){
    weeksMatches = [];
    const n = teams.length;
    let rotation = teams.slice();
    const isOdd = (n % 2 !== 0);
    if(isOdd) rotation.push(new Team("Bay","(Bay)"));
    const total = rotation.length;
    for(let week=0; week<total-1; week++){
        const matches = [];
        for(let i=0;i<total/2;i++){
            const home = rotation[i];
            const away = rotation[total-1-i];
            if(home.teamName !== "(Bay)" && away.teamName !== "(Bay)") matches.push([home, away]);
        }
        weeksMatches.push(matches);
        rotation.splice(1,0,rotation.pop());
    }
    // Rövanş: ters eşleşmeleri ekle (deplasman-home)
    const secondLegs = weeksMatches.map(week => week.map(([home,away]) => [away, home]));
    weeksMatches = weeksMatches.concat(secondLegs);
}

/* --------- Maç kaydetme & puan güncelleme ---------- */
function submitMatch(week, matchIndex){
    const matchDiv = document.getElementById("matchList").children[matchIndex];
    const goalsA = parseInt(matchDiv.querySelector(".scoreA").value);
    const goalsB = parseInt(matchDiv.querySelector(".scoreB").value);
    if(isNaN(goalsA) || isNaN(goalsB)){ alert("Gol girin!"); return; }

    const teamA = weeksMatches[week][matchIndex][0];
    const teamB = weeksMatches[week][matchIndex][1];

    // istatistikleri ekle
    teamA.goalsFor += goalsA; teamA.goalsAgainst += goalsB;
    teamB.goalsFor += goalsB; teamB.goalsAgainst += goalsA;
    teamA.played++; teamB.played++;

    if(goalsA > goalsB){ teamA.won++; teamB.lost++; }
    else if(goalsB > goalsA){ teamB.won++; teamA.lost++; }
    else { teamA.draw++; teamB.draw++; }

    // sonuç objesini sakla
    matchResults[`${week}-${matchIndex}`] = {
        homeGoals: goalsA, awayGoals: goalsB,
        homePlayer: teamA.playerName, awayPlayer: teamB.playerName,
        homeTeam: teamA.teamName, awayTeam: teamB.teamName,
        week: week+1
    };

    // otomatik ara kaydet
    saveAutoState();

    matchDiv.style.display = "none";
    const weekDivs = Array.from(document.getElementById("matchList").children);
    if(weekDivs.every(d => d.style.display === "none")){
        updateStandings();
        if(currentWeek < weeksMatches.length - 1){
            currentWeek++;
            showWeek(currentWeek);
        } else {
            // Lig tamamlandı
            showChampion();
        }
    }
}

function updateStandings(){
    const tbody = document.querySelector("#pointsTable tbody");
    tbody.innerHTML = '';
    const sorted = [...teams].sort((a,b) => b.points - a.points || b.goalDifference - a.goalDifference || b.goalsFor - a.goalsFor);
    sorted.forEach((t,i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${i+1}</td>
            <td>${t.playerName} (${t.teamName})</td>
            <td>${t.points}</td>
            <td>${t.played}</td>
            <td>${t.won}</td>
            <td>${t.draw}</td>
            <td>${t.lost}</td>
            <td>${t.goalsFor}</td>
            <td>${t.goalsAgainst}</td>
            <td>${t.goalDifference}</td>
        `;
        tbody.appendChild(tr);
    });
}

/* --------- Şampiyon gösterme & arşivleme ---------- */
function showChampion(){
    const sorted = [...teams].sort((a,b) => b.points - a.points || b.goalDifference - a.goalDifference || b.goalsFor - a.goalsFor);
    const champion = sorted[0];
    const photoUrl = playerPhotos[champion.playerName] || 'default.png';
    document.getElementById("championInfo").innerHTML = `<img src="${photoUrl}" alt="${champion.playerName}" class="champion-photo"> ${champion.playerName} (${champion.teamName})`;
    document.getElementById("championBox").style.display = "block";
    document.getElementById("matchSection").style.display = "none";

    triggerConfetti(80);

    // tamamlanmış turnuva verisi oluştur ve kaydet (archive)
    const tournamentData = {
        id: Date.now(),
        date: new Date().toISOString(),
        teams: teams.map(t => ({
            playerName: t.playerName, teamName: t.teamName, played: t.played, won: t.won, draw: t.draw, lost: t.lost,
            goalsFor: t.goalsFor, goalsAgainst: t.goalsAgainst, points: t.points, goalDifference: t.goalDifference
        })),
        champion: { playerName: champion.playerName, teamName: champion.teamName, photo: photoUrl },
        matches: []
    };
    for(let w=0; w<weeksMatches.length; w++){
        for(let mi=0; mi<weeksMatches[w].length; mi++){
            const key = `${w}-${mi}`;
            const res = matchResults[key];
            if(res){
                tournamentData.matches.push({
                    week: res.week, homePlayer: res.homePlayer, homeTeam: res.homeTeam, homeGoals: res.homeGoals,
                    awayPlayer: res.awayPlayer, awayTeam: res.awayTeam, awayGoals: res.awayGoals
                });
            }
        }
    }
    saveTournament(tournamentData);

    // tamamlandıktan sonra ara kaydı temizle (çünkü arşivlendi)
    clearAutoState();
    loadSavedList();
}

/* --------- LocalStorage: kayıt/ara-kayıt/arsiv işlemleri ---------- */
function saveTournament(data){
    try{
        const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        arr.unshift(data);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    } catch(e){
        console.error("Kaydetme hatası:", e);
        alert("Turnuva kaydedilirken bir hata oluştu.");
    }
}

function loadSavedList(){
    const savedListEl = document.getElementById("savedList");
    savedListEl.innerHTML = '';
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if(saved.length === 0){ savedListEl.innerHTML = `<li>Kaydedilmiş turnuva yok.</li>`; return; }
    saved.forEach((t, i) => {
        const li = document.createElement("li");
        const date = new Date(t.date);
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `<strong>${date.toLocaleString()}</strong> - Şampiyon: ${t.champion.playerName} (${t.champion.teamName})`;
        const actions = document.createElement("div");
        actions.innerHTML = `<button onclick="viewSaved(${i})">Görüntüle</button> <button onclick="deleteSaved(${i})">Sil</button>`;
        li.appendChild(meta);
        li.appendChild(actions);
        savedListEl.appendChild(li);
    });
}

function toggleSavedSection(){
    const sec = document.getElementById("savedSection");
    if(sec.style.display === "block"){ sec.style.display = "none"; }
    else { sec.style.display = "block"; loadSavedList(); document.getElementById("savedDetails").innerHTML = ''; }
}

function viewSaved(index){
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const t = saved[index];
    if(!t) return;
    const date = new Date(t.date);
    let html = `<h4>${date.toLocaleString()}</h4>`;
    html += `<p><img src="${t.champion.photo}" class="champion-photo" alt="şampiyon"> ${t.champion.playerName} (${t.champion.teamName})</p>`;
    html += `<h4>Puan Tablosu (kaydedilen)</h4>`;
    html += `<table><thead><tr><th>Sıra</th><th>Takım</th><th>Puan</th><th>O</th><th>G</th><th>B</th><th>M</th><th>AG</th><th>YG</th><th>AV</th></tr></thead><tbody>`;
    const sorted = t.teams.sort((a,b) => b.points - a.points || b.goalDifference - a.goalDifference || b.goalsFor - a.goalsFor);
    sorted.forEach((tt, idx) => {
        html += `<tr>
            <td>${idx+1}</td>
            <td>${tt.playerName} (${tt.teamName})</td>
            <td>${tt.points}</td>
            <td>${tt.played}</td>
            <td>${tt.won}</td>
            <td>${tt.draw}</td>
            <td>${tt.lost}</td>
            <td>${tt.goalsFor}</td>
            <td>${tt.goalsAgainst}</td>
            <td>${tt.goalDifference}</td>
        </tr>`;
    });
    html += `</tbody></table>`;
    html += `<h4>Maçlar</h4><ul>`;
    t.matches.forEach(m => {
        html += `<li>Hafta ${m.week}: ${m.homePlayer} (${m.homeTeam}) ${m.homeGoals} - ${m.awayGoals} ${m.awayPlayer} (${m.awayTeam})</li>`;
    });
    html += `</ul>`;
    document.getElementById("savedDetails").innerHTML = html;
    document.getElementById("savedDetails").scrollIntoView({behavior:'smooth'});
}

function deleteSaved(index){
    if(!confirm("Bu kaydı silmek istediğine emin misin?")) return;
    const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    arr.splice(index,1);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    loadSavedList();
    document.getElementById("savedDetails").innerHTML = '';
}

/* --------- Otomatik ara kaydetme: ongoing state ---------- */
function saveAutoState(){
    try{
        // teams snapshot
        const teamsSnap = teams.map(t => ({
            playerName: t.playerName, teamName: t.teamName, played: t.played, won: t.won, draw: t.draw, lost: t.lost,
            goalsFor: t.goalsFor, goalsAgainst: t.goalsAgainst
        }));
        // weeksMatches snapshot: array of array of { home: {playerName,teamName}, away: {...} }
        const weeksSnap = weeksMatches.map(week => week.map(([home, away]) => ({
            home: { playerName: home.playerName, teamName: home.teamName },
            away: { playerName: away.playerName, teamName: away.teamName }
        })));
        const autosave = {
            date: new Date().toISOString(),
            teams: teamsSnap,
            weeksMatches: weeksSnap,
            currentWeek,
            matchResults
        };
        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(autosave));
        // küçük geri bildirim (opsiyonel): console
        console.log("Ara kayıt yapıldı.");
    } catch(e){
        console.error("Ara kaydetme hatası:", e);
    }
}

function loadAutoState(){
    const raw = localStorage.getItem(AUTOSAVE_KEY);
    if(!raw) return false;
    try{
        const data = JSON.parse(raw);
        // temizle önce
        teams.length = 0;
        for(const k in matchResults) delete matchResults[k];
        weeksMatches = [];
        currentWeek = data.currentWeek || 0;

        // Yeniden Team nesnelerini oluştur ve istatistikleri ata
        data.teams.forEach(t => {
            const team = new Team(t.playerName, t.teamName);
            team.played = t.played; team.won = t.won; team.draw = t.draw; team.lost = t.lost;
            team.goalsFor = t.goalsFor; team.goalsAgainst = t.goalsAgainst;
            teams.push(team);
        });

        // weeksMatches'i yeniden kur: her home/away eşi için teams içinden referansı bul
        weeksMatches = data.weeksMatches.map(week => week.map(pair => {
            const home = teams.find(tt => tt.playerName === pair.home.playerName && tt.teamName === pair.home.teamName)
                        || new Team(pair.home.playerName, pair.home.teamName);
            const away = teams.find(tt => tt.playerName === pair.away.playerName && tt.teamName === pair.away.teamName)
                        || new Team(pair.away.playerName, pair.away.teamName);
            return [home, away];
        }));

        // matchResults kopyala
        for(const k in data.matchResults) matchResults[k] = data.matchResults[k];

        updateTeamList();
        updateStandings();
        return true;
    } catch(e){
        console.error("Ara kayıt yükleme hatası:", e);
        return false;
    }
}

function clearAutoState(){
    localStorage.removeItem(AUTOSAVE_KEY);
    console.log("Ara kayıt temizlendi.");
}

/* --------- Konfeti ---------- */
function triggerConfetti(count = 60){
    const container = document.getElementById("confettiContainer");
    container.innerHTML = '';
    const colors = ["#FFD700","#FF6B6B","#6BCB77","#4D96FF","#FFB86B"];
    for(let i=0;i<count;i++){
        const el = document.createElement("div");
        el.className = 'confetti';
        el.style.background = colors[Math.floor(Math.random()*colors.length)];
        el.style.left = Math.random()*100 + '%';
        el.style.top = (-10 - Math.random()*10) + 'vh';
        const scale = 0.7 + Math.random()*0.8;
        el.style.width = (8*scale) + 'px';
        el.style.height = (12*scale) + 'px';
        const dur = 3 + Math.random()*3;
        el.style.animationDuration = dur + 's';
        el.style.animationDelay = (Math.random()*0.5) + 's';
        container.appendChild(el);
    }
    setTimeout(()=>{ container.innerHTML = ''; }, 7000);
}

/* --------- Başlangıç: sayfa yüklendiğinde ara kayıt kontrolü ---------- */
document.addEventListener('DOMContentLoaded', () => {
    loadSavedList();

    // Ara kayıt varsa kullanıcıya sor
    const raw = localStorage.getItem(AUTOSAVE_KEY);
    if(raw){
        const proceed = confirm("Devam eden bir turnuva bulundu. Kaldığın yerden devam etmek ister misin? (İptal = silinir)");
        if(proceed){
            const ok = loadAutoState();
            if(ok){
                // Eğer yüklendiyse UI ayarları
                document.getElementById("startTournamentBtn").style.display = "none";
                document.getElementById("showSavedBtn").style.display = "none";
                showWeek(currentWeek);
            } else {
                alert("Ara kayıt yüklenemedi, temizleniyor.");
                clearAutoState();
            }
        } else {
            clearAutoState();
        }
    }
});
</script>
</body>
</html>
