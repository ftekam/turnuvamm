<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Futbol Turnuvası</title>
<style>
    html, body { height:100%; margin:0; padding:0; background-color:black; }
    body {
        font-family: Arial, sans-serif;
        background: url('photo_001.png') no-repeat center bottom;
        background-size: cover; color:#fff;
    }
    h1 { text-align:center; margin-top:20px; text-shadow:2px 2px #000; }
    input, button { padding:8px; margin:5px; font-size:20px; border-radius:5px; border:none; }
    button { background-color:#1a73e8; color:#fff; cursor:pointer; }
    button:hover { background-color:#155ab6; }
    .team-entry, .team-list, .match-section, .standings, .champion-box, .saved-section {
        background-color: rgba(0,0,50,0.8);
        margin: 15px auto; padding:20px; border-radius:10px; max-width:750px;
    }
    .team-list ul { list-style:none; padding-left:0; }
    .team-list li { padding:5px; border-bottom:1px solid #ccc; display:flex; align-items:center; }
    .team-list img { width:40px; height:40px; border-radius:50%; margin-right:10px; border:2px solid #fff; }

    .match-card { background-color: rgba(255,255,255,0.1); padding:10px; margin-bottom:10px; border-radius:8px;
        display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .match-card input { width:50px; text-align:center; }

    table { width:100%; border-collapse:collapse; margin-top:10px; background-color: rgba(0,0,80,0.7); border-radius:10px; overflow:hidden; }
    th, td { border:1px solid #fff; padding:5px; text-align:center; font-size:14px; }
    th { background-color: rgba(0,0,100,0.8); }

    .tournament { text-align:center; }

    .champion-box h3 { text-align:center; margin:0; }
    .champion-box p { display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:bold; }
    .champion-photo { width:80px; height:80px; border-radius:50%; margin-right:20px; border:4px solid gold; }

    .saved-list { list-style:none; padding-left:0; }
    .saved-list li { padding:8px; border-bottom:1px solid #666; display:flex; justify-content:space-between; align-items:center; }
    .saved-list .meta { display:flex; align-items:center; gap:10px; }

    .confetti-container { position: fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; overflow:visible; z-index:9999; }
    .confetti { position:absolute; width:10px; height:14px; opacity:0.9; transform-origin:center; will-change:transform, top; animation: fall linear forwards; }
    @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity:1; } 100% { transform: translateY(110vh) rotate(720deg); opacity:0.9; } }

    @media (max-width:600px) { th, td { font-size:12px; padding:4px; } input, button { font-size:14px; padding:4px; } .match-card { flex-direction:column; } }
</style>
</head>
<body>
<h1>Futbol Turnuvası</h1>

<div class="team-entry">
    <input type="text" id="playerName" placeholder="Oyuncu Adı" />
    <input type="text" id="teamName" placeholder="Takım Adı" />
    <button id="addTeamBtn">Takımı Ekle</button>
    <button id="clearTeamsBtn">Takımları Temizle</button>
</div>

<div class="team-list">
    <h3>Takımlar:</h3>
    <ul id="teamList"></ul>
</div>

<div class="tournament">
    <button id="startTournamentBtn">Turnuvayı Başlat</button>
    <button id="showSavedBtn">Eski Turnuvaları Göster</button>

    <div class="match-section" id="matchSection" style="display:none;">
        <h3 id="weekTitle"></h3>
        <div id="matchList"></div>
    </div>

    <div class="standings" id="standings">
        <h3>Puan Tablosu:</h3>
        <table id="pointsTable">
            <thead>
                <tr>
                    <th>Sıra</th><th>Takım</th><th>Puan</th><th>O</th><th>G</th><th>B</th><th>M</th><th>AG</th><th>YG</th><th>AV</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="champion-box" id="championBox" style="display:none;">
        <h3>Şampiyon:</h3>
        <p id="championInfo"></p>
        <div style="text-align:center; margin-top:10px;"><button id="archiveClearBtn">Arşive Aktarıldıysa Bu Turnuvayı Temizle</button></div>
    </div>

    <div class="saved-section" id="savedSection" style="display:none;">
        <h3>Eski Turnuvalar</h3>
        <ul id="savedList" class="saved-list"></ul>
        <div id="savedDetails" style="margin-top:10px;"></div>
    </div>
</div>

<div class="confetti-container" id="confettiContainer" aria-hidden="true"></div>

<script>
/* --------- Ayarlar / Anahtarlar ---------- */
const STORAGE_KEY = 'savedTournaments_v1';   // tamamlanmışlar
const AUTOSAVE_KEY = 'ongoingTournament_v1'; // devam eden turnuva
const playerPhotos = {"Faruk":"Faruk.png","Rıza":"Rıza.png","Hakan":"Hakan.png","Salih":"Salih.png","Hidayet":"Hidayet.png","Ergün":"Ergün.png","İsmail":"İsmail.png","Uğur":"default.png"};

/* --------- Veri yapıları ---------- */
const teams = [];
let weeksMatches = [];
let currentWeek = 0;
const matchResults = {};

/* --------- Sınıf ---------- */
class Team {
    constructor(playerName, teamName) {
        this.playerName = playerName;
        this.teamName = teamName;
        this.played = 0;
        this.won = 0;
        this.draw = 0;
        this.lost = 0;
        this.goalsFor = 0;
        this.goalsAgainst = 0;
    }
    get points(){ return this.won*3 + this.draw; }
    get goalDifference(){ return this.goalsFor - this.goalsAgainst; }
}

/* --------- Butonlar / Eventler ---------- */
document.getElementById("addTeamBtn").onclick = () => {
    const player = document.getElementById("playerName").value.trim();
    const team = document.getElementById("teamName").value.trim();
    if(player && team){
        teams.push(new Team(player, team));
        updateTeamList();
        document.getElementById("playerName").value = '';
        document.getElementById("teamName").value = '';
    } else alert("Tüm alanları doldurun!");
};

document.getElementById("clearTeamsBtn").onclick = () => {
    if(confirm("Tüm takımları temizlemek istiyor musun?")) {
        teams.length = 0;
        updateTeamList();
        clearAutoState();
    }
};

document.getElementById("startTournamentBtn").onclick = () => {
    if(teams.length < 2){ alert("Turnuva başlatmak için en az 2 takım ekleyin!"); return; }
    resetStats();
    prepareWeeklyMatches();
    saveAutoState();
    document.getElementById("startTournamentBtn").style.display = "none";
    document.getElementById("showSavedBtn").style.display = "none";
    showWeek(currentWeek);
};

document.getElementById("showSavedBtn").onclick = toggleSavedSection;
document.getElementById("archiveClearBtn").onclick = () => {
    if(confirm("Bu tamamlanmış turnuvayı temizlemek ve yeni bir turnuva başlatmak istiyor musun?")){
        clearAutoState();
        teams.length = 0;
        updateTeamList();
        document.getElementById("championBox").style.display = "none";
        document.getElementById("startTournamentBtn").style.display = "inline-block";
        document.getElementById("showSavedBtn").style.display = "inline-block";
        document.getElementById("savedDetails").innerHTML = '';
    }
};

/* --------- Görüntüleme güncellemeleri ---------- */
function updateTeamList(){
    const ul = document.getElementById("teamList");
    ul.innerHTML = '';
    teams.forEach(t => {
        const li = document.createElement("li");
        const photoUrl = playerPhotos[t.playerName] || 'default.png';
        li.innerHTML = `<img src="${photoUrl}" alt="${t.playerName}"><span>${t.playerName} - ${t.teamName}</span>`;
        ul.appendChild(li);
    });
}

function showWeek(week){
    document.getElementById("matchSection").style.display = "block";
    document.getElementById("weekTitle").textContent = `Hafta ${week+1} / Toplam ${weeksMatches.length} Hafta`;
    const matchList = document.getElementById("matchList");
    matchList.innerHTML = '';
    weeksMatches[week].forEach((m, i) => {
        const div = document.createElement("div");
        div.className = "match-card";
        const key = `${week}-${i}`;
        const existing = matchResults[key];
        const valA = existing ? existing.homeGoals : '';
        const valB = existing ? existing.awayGoals : '';
        div.innerHTML = `
            <span>${m[0].playerName} (${m[0].teamName}) vs ${m[1].playerName} (${m[1].teamName})</span>
            <input type="number" placeholder="Gol" class="scoreA" value="${valA}">
            <input type="number" placeholder="Gol" class="scoreB" value="${valB}">
            <button onclick="submitMatch(${week},${i})">Kaydet</button>
        `;
        matchList.appendChild(div);
    });
}

/* --------- Lig & Fikstür ---------- */
function resetStats(){
    teams.forEach(t => {
        t.played = t.won = t.draw = t.lost = t.goalsFor = t.goalsAgainst = 0;
    });
    currentWeek = 0;
    matchResults = {};
}

function prepareWeeklyMatches(){
    weeksMatches = [];
    const shuffled = [...teams].sort(()=>Math.random()-0.5);
    const numWeeks = teams.length - 1;
    for(let w=0; w<numWeeks; w++){
        const week = [];
        for(let i=0;i<Math.floor(shuffled.length/2);i++){
            week.push([shuffled[i], shuffled[shuffled.length-i-1]]);
        }
        weeksMatches.push(week);
    }
}

function submitMatch(week, idx){
    const m = weeksMatches[week][idx];
    const inputs = document.getElementsByClassName("match-card")[idx].getElementsByTagName("input");
    const aGoals = parseInt(inputs[0].value)||0;
    const bGoals = parseInt(inputs[1].value)||0;

    matchResults[`${week}-${idx}`] = {homeGoals:aGoals, awayGoals:bGoals};
    // istatistik güncelle
    m[0].played++; m[1].played++;
    m[0].goalsFor += aGoals; m[0].goalsAgainst += bGoals;
    m[1].goalsFor += bGoals; m[1].goalsAgainst += aGoals;
    if(aGoals>bGoals){ m[0].won++; m[1].lost++; }
    else if(aGoals<bGoals){ m[0].lost++; m[1].won++; }
    else{ m[0].draw++; m[1].draw++; }

    updateStandings();
    saveAutoState();

    // haftanın tamamlanıp tamamlanmadığını kontrol
    const allDone = weeksMatches[week].every((_,i)=>matchResults[`${week}-${i}`]);
    if(allDone){
        currentWeek++;
        if(currentWeek<weeksMatches.length) showWeek(currentWeek);
        else showChampion();
    }
}

function updateStandings(){
    const tbody = document.querySelector("#pointsTable tbody");
    tbody.innerHTML = '';
    const sorted = [...teams].sort((a,b)=>{
        if(b.points !== a.points) return b.points - a.points;
        return b.goalDifference - a.goalDifference;
    });
    sorted.forEach((t,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td><td>${t.teamName}</td><td>${t.points}</td><td>${t.played}</td><td>${t.won}</td><td>${t.draw}</td><td>${t.lost}</td><td>${t.goalsFor}</td><td>${t.goalsAgainst}</td><td>${t.goalDifference}</td>`;
        tbody.appendChild(tr);
    });
}

/* --------- Şampiyon ---------- */
function showChampion(){
    document.getElementById("championBox").style.display = "block";
    const winner = teams.reduce((a,b)=>a.points>=b.points?a:b);
    const img = playerPhotos[winner.playerName]||'default.png';
    document.getElementById("championInfo").innerHTML = `<img src="${img}" class="champion-photo">${winner.playerName} - ${winner.teamName}`;
    spawnConfetti();
    saveTournament();
    clearAutoState();
}

/* --------- Eski Turnuvalar ---------- */
function saveTournament(){
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    arr.push({
        date: new Date().toLocaleString(),
        teams: teams.map(t=>({playerName:t.playerName, teamName:t.teamName, points:t.points})),
        winner: teams.reduce((a,b)=>a.points>=b.points?a:b)
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

function toggleSavedSection(){
    const sec = document.getElementById("savedSection");
    sec.style.display = sec.style.display==='none'?'block':'none';
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    const ul = document.getElementById("savedList");
    ul.innerHTML = '';
    arr.forEach((t,i)=>{
        const li = document.createElement("li");
        li.innerHTML = `<span>${t.date} - Kazanan: ${t.winner.playerName}</span> <button onclick="showSavedDetails(${i})">Detay</button>`;
        ul.appendChild(li);
    });
}

function showSavedDetails(idx){
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    const t = arr[idx];
    let html = '<ul>';
    t.teams.forEach(team=>{
        html += `<li>${team.playerName} - ${team.teamName} - ${team.points} Puan</li>`;
    });
    html += '</ul>';
    document.getElementById("savedDetails").innerHTML = html;
}

/* --------- Kaydetme / Yükleme (sorun çözüldü) ---------- */
function saveAutoState(){
    const data = {
        currentWeek,
        weeksMatches,
        teams: teams.map(t=>({...t})),
        matchResults
    };
    localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
}

function loadAutoState(){
    const raw = localStorage.getItem(AUTOSAVE_KEY);
    if(!raw) return false;
    try{
        const data = JSON.parse(raw);
        teams.length = 0;
        for(const k in matchResults) delete matchResults[k];
        weeksMatches = data.weeksMatches.map(week => week.map(pair => {
            const home = new Team(pair[0].playerName, pair[0].teamName);
            const away = new Team(pair[1].playerName, pair[1].teamName);
            Object.assign(home, pair[0]);
            Object.assign(away, pair[1]);
            return [home, away];
        }));
        data.teams.forEach(t=>{
            const team = teams.find(tt => tt.playerName===t.playerName && tt.teamName===t.teamName);
            if(team){
                Object.assign(team,t);
            } else teams.push(new Team(t.playerName, t.teamName));
        });
        for(const k in data.matchResults) matchResults[k] = data.matchResults[k];
        currentWeek = data.currentWeek !== undefined ? data.currentWeek : 0;
        updateTeamList();
        updateStandings();
        if(currentWeek<weeksMatches.length) showWeek(currentWeek);
        return true;
    } catch(e){ console.error(e); return false; }
}

function clearAutoState(){ localStorage.removeItem(AUTOSAVE_KEY); }

/* --------- Confetti ---------- */
function spawnConfetti(){
    const container = document.getElementById("confettiContainer");
    for(let i=0;i<100;i++){
        const c = document.createElement("div");
        c.className = 'confetti';
        c.style.backgroundColor = `hsl(${Math.random()*360}, 70%, 60%)`;
        c.style.left = `${Math.random()*100}%`;
        c.style.top = `${-10 + Math.random()*10}vh`;
        c.style.animationDuration = `${2+Math.random()*3}s`;
        container.appendChild(c);
        setTimeout(()=>c.remove(),5000);
    }
}

/* --------- Başlangıçta yükle ---------- */
window.onload = () => {
    loadAutoState();
};
</script>
</body>
</html>
