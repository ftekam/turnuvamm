<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Futbol Turnuvası</title>
<style>
    html, body { height:100%; margin:0; padding:0; background-color:black; }
    body {
        font-family: Arial, sans-serif;
        background: url('photo_001.png') no-repeat center bottom;
        background-size: cover; color:#fff;
    }
    h1 { text-align:center; margin-top:20px; text-shadow:2px 2px #000; }
    input, button { padding:8px; margin:5px; font-size:20px; border-radius:5px; border:none; }
    button { background-color:#1a73e8; color:#fff; cursor:pointer; }
    button:hover { background-color:#155ab6; }
    .team-entry, .team-list, .match-section, .standings, .champion-box, .saved-section {
        background-color: rgba(0,0,50,0.8);
        margin: 15px auto; padding:20px; border-radius:10px; max-width:750px;
    }
    .team-list ul { list-style:none; padding-left:0; }
    .team-list li { padding:5px; border-bottom:1px solid #ccc; display:flex; align-items:center; }
    .team-list img { width:40px; height:40px; border-radius:50%; margin-right:10px; border:2px solid #fff; }

    .match-card { background-color: rgba(255,255,255,0.1); padding:10px; margin-bottom:10px; border-radius:8px;
        display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
    .match-card input { width:50px; text-align:center; }

    table { width:100%; border-collapse:collapse; margin-top:10px; background-color: rgba(0,0,80,0.7); border-radius:10px; overflow:hidden; }
    th, td { border:1px solid #fff; padding:5px; text-align:center; font-size:14px; }
    th { background-color: rgba(0,0,100,0.8); }

    .tournament { text-align:center; }

    .champion-box h3 { text-align:center; margin:0; }
    .champion-box p { display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:bold; }
    .champion-photo { width:80px; height:80px; border-radius:50%; margin-right:20px; border:4px solid gold; }

    .saved-list { list-style:none; padding-left:0; }
    .saved-list li { padding:8px; border-bottom:1px solid #666; display:flex; justify-content:space-between; align-items:center; }
    .saved-list .meta { display:flex; align-items:center; gap:10px; }

    .confetti-container { position: fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; overflow:visible; z-index:9999; }
    .confetti { position:absolute; width:10px; height:14px; opacity:0.9; transform-origin:center; will-change:transform, top; animation: fall linear forwards; }
    @keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity:1; } 100% { transform: translateY(110vh) rotate(720deg); opacity:0.9; } }

    @media (max-width:600px) { th, td { font-size:12px; padding:4px; } input, button { font-size:14px; padding:4px; } .match-card { flex-direction:column; } }
</style>
</head>
<body>
<h1>Futbol Turnuvası</h1>

<div class="team-entry">
    <input type="text" id="playerName" placeholder="Oyuncu Adı" />
    <input type="text" id="teamName" placeholder="Takım Adı" />
    <button id="addTeamBtn">Takımı Ekle</button>
    <button id="clearTeamsBtn">Takımları Temizle</button>
</div>

<div class="team-list">
    <h3>Takımlar:</h3>
    <ul id="teamList"></ul>
</div>

<div class="tournament">
    <button id="startTournamentBtn">Turnuvayı Başlat</button>
    <button id="showSavedBtn">Eski Turnuvaları Göster</button>

    <div class="match-section" id="matchSection" style="display:none;">
        <h3 id="weekTitle"></h3>
        <div id="matchList"></div>
    </div>

    <div class="standings" id="standings">
        <h3>Puan Tablosu:</h3>
        <table id="pointsTable">
            <thead>
                <tr>
                    <th>Sıra</th><th>Takım</th><th>Puan</th><th>O</th><th>G</th><th>B</th><th>M</th><th>AG</th><th>YG</th><th>AV</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="champion-box" id="championBox" style="display:none;">
        <h3>Şampiyon:</h3>
        <p id="championInfo"></p>
        <div style="text-align:center; margin-top:10px;"><button id="archiveClearBtn">Arşive Aktarıldıysa Bu Turnuvayı Temizle</button></div>
    </div>

    <div class="saved-section" id="savedSection" style="display:none;">
        <h3>Eski Turnuvalar</h3>
        <ul id="savedList" class="saved-list"></ul>
        <div id="savedDetails" style="margin-top:10px;"></div>
    </div>
</div>

<div class="confetti-container" id="confettiContainer" aria-hidden="true"></div>

<script>
/* --------- Ayarlar / Anahtarlar ---------- */
const STORAGE_KEY = 'savedTournaments_v1';
const AUTOSAVE_KEY = 'ongoingTournament_v1';
const playerPhotos = {"Faruk":"Faruk.png","Rıza":"Rıza.png","Hakan":"Hakan.png","Salih":"Salih.png","Hidayet":"Hidayet.png","Ergün":"Ergün.png","İsmail":"İsmail.png","Uğur":"default.png"};

/* --------- Veri yapıları ---------- */
const teams = [];
let weeksMatches = [];
let currentWeek = 0;
const matchResults = {};

/* --------- Sınıf ---------- */
class Team {
    constructor(playerName, teamName) {
        this.playerName = playerName;
        this.teamName = teamName;
        this.played = 0;
        this.won = 0;
        this.draw = 0;
        this.lost = 0;
        this.goalsFor = 0;
        this.goalsAgainst = 0;
    }
    get points(){ return this.won*3 + this.draw; }
    get goalDifference(){ return this.goalsFor - this.goalsAgainst; }
}

/* --------- Butonlar / Eventler ---------- */
document.getElementById("addTeamBtn").onclick = () => {
    const player = document.getElementById("playerName").value.trim();
    const team = document.getElementById("teamName").value.trim();
    if(player && team){
        teams.push(new Team(player, team));
        updateTeamList();
        document.getElementById("playerName").value = '';
        document.getElementById("teamName").value = '';
    } else alert("Tüm alanları doldurun!");
};

document.getElementById("clearTeamsBtn").onclick = () => {
    if(confirm("Tüm takımları temizlemek istiyor musun?")) {
        teams.length = 0;
        updateTeamList();
        clearAutoState();
    }
};

document.getElementById("startTournamentBtn").onclick = () => {
    if(teams.length < 2){ alert("Turnuva başlatmak için en az 2 takım ekleyin!"); return; }
    resetStats();
    prepareWeeklyMatches();
    saveAutoState();
    document.getElementById("startTournamentBtn").style.display = "none";
    document.getElementById("showSavedBtn").style.display = "none";
    showWeek(currentWeek);
};

document.getElementById("showSavedBtn").onclick = toggleSavedSection;
document.getElementById("archiveClearBtn").onclick = () => {
    if(confirm("Bu tamamlanmış turnuvayı temizlemek ve yeni bir turnuva başlatmak istiyor musun?")){
        clearAutoState();
        teams.length = 0;
        updateTeamList();
        document.getElementById("championBox").style.display = "none";
        document.getElementById("startTournamentBtn").style.display = "inline-block";
        document.getElementById("showSavedBtn").style.display = "inline-block";
        document.getElementById("savedDetails").innerHTML = '';
    }
};

/* --------- Görüntüleme güncellemeleri ---------- */
function updateTeamList(){
    const ul = document.getElementById("teamList");
    ul.innerHTML = '';
    teams.forEach(t => {
        const li = document.createElement("li");
        const photoUrl = playerPhotos[t.playerName] || 'default.png';
        li.innerHTML = `<img src="${photoUrl}" alt="${t.playerName}"><span>${t.playerName} - ${t.teamName}</span>`;
        ul.appendChild(li);
    });
}

function showWeek(week){
    document.getElementById("matchSection").style.display = "block";
    document.getElementById("weekTitle").textContent = `Hafta ${week+1} / Toplam ${weeksMatches.length} Hafta`;
    const matchList = document.getElementById("matchList");
    matchList.innerHTML = '';
    weeksMatches[week].forEach((m, i) => {
        const div = document.createElement("div");
        div.className = "match-card";
        const key = `${week}-${i}`;
        const existing = matchResults[key];
        const valA = existing ? existing.homeGoals : '';
        const valB = existing ? existing.awayGoals : '';
        div.innerHTML = `
            <span>${m[0].playerName} (${m[0].teamName}) vs ${m[1].playerName} (${m[1].teamName})</span>
            <input type="number" min="0" placeholder="0" value="${valA}" id="home-${key}">
            <input type="number" min="0" placeholder="0" value="${valB}" id="away-${key}">
            <button onclick="submitMatch('${key}',${week},${i})">Kaydet</button>
        `;
        matchList.appendChild(div);
    });
}

function submitMatch(key, week, matchIndex){
    const homeG = parseInt(document.getElementById(`home-${key}`).value);
    const awayG = parseInt(document.getElementById(`away-${key}`).value);
    if(isNaN(homeG) || isNaN(awayG)) { alert("Skorları girin!"); return; }
    matchResults[key] = {homeGoals: homeG, awayGoals: awayG};
    const m = weeksMatches[week][matchIndex];
    m[0].played++; m[1].played++;
    m[0].goalsFor += homeG; m[0].goalsAgainst += awayG;
    m[1].goalsFor += awayG; m[1].goalsAgainst += homeG;
    if(homeG>awayG){ m[0].won++; m[1].lost++; }
    else if(homeG<awayG){ m[1].won++; m[0].lost++; }
    else { m[0].draw++; m[1].draw++; }
    updateStandings();
    if(matchIndex === weeksMatches[week].length - 1){
        currentWeek++;
        saveAutoState();
        if(currentWeek < weeksMatches.length) showWeek(currentWeek);
        else showChampion();
    }
}

function updateStandings(){
    const tbody = document.querySelector("#pointsTable tbody");
    tbody.innerHTML = '';
    const sorted = [...teams].sort((a,b) => b.points - a.points || b.goalDifference - a.goalDifference || b.goalsFor - a.goalsFor);
    sorted.forEach((t,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td><td>${t.teamName}</td><td>${t.points}</td><td>${t.played}</td><td>${t.won}</td><td>${t.draw}</td><td>${t.lost}</td><td>${t.goalsFor}</td><td>${t.goalsAgainst}</td><td>${t.goalDifference}</td>`;
        tbody.appendChild(tr);
    });
}

/* --------- Haftalar / Maçlar ---------- */
function resetStats(){
    teams.forEach(t=>{
        t.played=0; t.won=0; t.draw=0; t.lost=0; t.goalsFor=0; t.goalsAgainst=0;
    });
    currentWeek = 0;
    matchResults = {};
    weeksMatches = [];
    document.getElementById("championBox").style.display = "none";
}

function prepareWeeklyMatches(){
    const copy = [...teams];
    for(let w=0; w<teams.length-1; w++){
        const weekMatches = [];
        while(copy.length >=2){
            const a = copy.shift();
            const b = copy.shift();
            weekMatches.push([a,b]);
        }
        weeksMatches.push(weekMatches);
        copy.push(...teams);
    }
}

/* --------- Şampiyon ---------- */
function showChampion(){
    const sorted = [...teams].sort((a,b)=>b.points - a.points || b.goalDifference - a.goalDifference);
    const champ = sorted[0];
    const champInfo = document.getElementById("championInfo");
    champInfo.innerHTML = `<img class="champion-photo" src="${playerPhotos[champ.playerName] || 'default.png'}" alt="${champ.playerName}"> ${champ.playerName} - ${champ.teamName}`;
    document.getElementById("championBox").style.display = "block";
    runConfetti();
    archiveTournament();
}

/* --------- Confetti ---------- */
function runConfetti(){
    const container = document.getElementById("confettiContainer");
    for(let i=0;i<200;i++){
        const div = document.createElement("div");
        div.className = "confetti";
        div.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
        div.style.left = `${Math.random()*100}%`;
        div.style.top = `${-10 + Math.random()*20}vh`;
        div.style.width = `${5+Math.random()*5}px`;
        div.style.height = `${10+Math.random()*10}px`;
        div.style.animationDuration = `${3+Math.random()*3}s`;
        container.appendChild(div);
        setTimeout(()=>div.remove(),6000);
    }
}

/* --------- Kaydetme / Yükleme ---------- */
function saveAutoState(){
    const data = {
        teams,
        weeksMatches,
        matchResults,
        currentWeek
    };
    localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
}

function loadAutoState(){
    const saved = localStorage.getItem(AUTOSAVE_KEY);
    if(saved){
        const data = JSON.parse(saved);
        teams.length = 0;
        data.teams.forEach(t=>{
            const team = new Team(t.playerName, t.teamName);
            Object.assign(team, t);
            teams.push(team);
        });
        weeksMatches = data.weeksMatches;
        Object.assign(matchResults, data.matchResults);
        currentWeek = data.currentWeek || 0; // <-- önemli fix
        updateTeamList();
        if(currentWeek < weeksMatches.length) showWeek(currentWeek);
        else showChampion();
    }
}

function clearAutoState(){
    localStorage.removeItem(AUTOSAVE_KEY);
}

/* --------- Arşiv ---------- */
function archiveTournament(){
    const archive = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
    archive.push({date:new Date().toLocaleString(), teams:JSON.parse(JSON.stringify(teams))});
    localStorage.setItem(STORAGE_KEY, JSON.stringify(archive));
}

function toggleSavedSection(){
    const sec = document.getElementById("savedSection");
    sec.style.display = sec.style.display === 'block' ? 'none' : 'block';
    if(sec.style.display==='block'){
        loadSavedList();
    }
}

function loadSavedList(){
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
    const ul = document.getElementById("savedList");
    ul.innerHTML = '';
    saved.forEach((t,i)=>{
        const li = document.createElement("li");
        li.innerHTML = `<span>${t.date}</span><div class="meta"><button onclick="viewSaved(${i})">Göster</button></div>`;
        ul.appendChild(li);
    });
}

function viewSaved(index){
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
    const t = saved[index];
    let html = `<table><thead><tr><th>Takım</th><th>Puan</th></tr></thead><tbody>`;
    t.teams.forEach(tm=>{
        html += `<tr><td>${tm.teamName}</td><td>${tm.points}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById("savedDetails").innerHTML = html;
}

/* --------- Başlangıçta otomatik yükle ---------- */
window.onload = () => {
    loadAutoState();
};
</script>
</body>
</html>
